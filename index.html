<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rainwater Harvesting Calculator | The Permaculture Lab</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Google Maps API -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAuFONHLyXGalqEH9VL3oFl8MpHgF7sa5k&libraries=drawing,geometry,places"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        permBg: '#34495E',
                        permButton: '#EC1E7D',
                        permLightBrown: '#D2B48C',
                        permBrown: '#8B4513',
                        permTan: '#F5DEB3',
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #34495E;
            color: #fff;
        }
        .dark .chart-container canvas {
            filter: invert(0.9) hue-rotate(180deg);
        }
        #map-container {
            height: 400px;
            width: 100%;
        }
        .area-list-item {
            cursor: pointer;
            transition: all 0.2s;
        }
        .area-list-item:hover {
            background-color: rgba(210, 180, 140, 0.2);
        }
        .area-list-item.selected {
            background-color: rgba(210, 180, 140, 0.3);
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.1);
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border-left-color: #EC1E7D;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Search box styling */
        .map-search-container {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10;
            width: 90%;
            max-width: 500px;
        }
        .pac-container {
            z-index: 1051 !important;
        }
        .panel-card {
            background-color: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .area-card {
            background-color: rgba(139, 69, 19, 0.2);
        }
        .button-primary {
            background-color: #EC1E7D;
        }
        .button-primary:hover {
            background-color: #d41a6d;
        }
        .button-secondary {
            background-color: rgba(210, 180, 140, 0.3);
        }
        .button-secondary:hover {
            background-color: rgba(210, 180, 140, 0.5);
        }
        .logo {
            max-height: 80px;
            margin: 0 auto;
        }
        .tab-active {
            border-bottom-color: #EC1E7D;
            color: #EC1E7D;
        }
        .category-tab {
            background-color: rgba(255, 255, 255, 0.05);
            border-bottom: 2px solid transparent;
        }
        .category-tab:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        .category-tab.active {
            border-bottom-color: #EC1E7D;
            background-color: rgba(255, 255, 255, 0.15);
        }
        /* Help tooltip styling */
        .tooltip {
            position: relative;
            display: inline-block;
            cursor: help;
        }
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 300px;
            background-color: rgba(0, 0, 0, 0.8);
            color: #fff;
            text-align: left;
            border-radius: 6px;
            padding: 10px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.85rem;
            line-height: 1.4;
        }
        .tooltip .tooltiptext::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: rgba(0, 0, 0, 0.8) transparent transparent transparent;
        }
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        .result-card {
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.05);
            border-radius: 0.5rem;
        }
        .result-card.building {
            border-left: 4px solid #EC1E7D;
        }
        .result-card.road {
            border-left: 4px solid #F57C00;
        }
        .result-card.land {
            border-left: 4px solid #43A047;
        }
        .no-data-message {
            color: rgba(255, 255, 255, 0.7);
            font-style: italic;
            text-align: center;
            padding: 1rem;
        }
    </style>
</head>
<body>
    <div class="min-h-screen flex flex-col">
        <header class="py-4 px-4 shadow-md bg-permBg">
            <div class="container mx-auto flex flex-col items-center justify-center">
                <img src="https://github.com/welcometherain/assets/raw/main/perm%20lab%20brown2.png" alt="The Permaculture Lab Logo" class="logo mb-2">
                <h1 class="text-2xl font-bold text-center">Rainwater Harvesting Calculator</h1>
                <p class="text-sm md:text-base italic text-permTan">Calculate your rainwater collection potential</p>
            </div>
        </header>

        <main class="container mx-auto p-4 flex-grow">
            <!-- Map Area Measurement Section -->
            <div class="panel-card rounded-lg shadow-md p-6 mb-6">
                <h2 class="text-xl font-semibold mb-4">Measure Collection Areas</h2>
                
                <div class="grid md:grid-cols-3 gap-6">
                    <div class="md:col-span-2">
                        <div class="mb-3">
                            <label for="address-input" class="block text-sm font-medium mb-1">Search for an address:</label>
                            <div class="flex">
                                <input type="text" id="address-input" placeholder="Enter address, city, or zip code" 
                                    class="flex-grow p-2 border rounded-l-md text-base bg-gray-700 border-gray-600 text-white">
                                <button id="address-search-btn" class="button-primary text-white px-4 py-2 rounded-r-md">Search</button>
                            </div>
                        </div>
                        
                        <div id="map-container" class="rounded-lg overflow-hidden border border-gray-600 relative">
                            <!-- Search box will be positioned here -->
                            <div class="map-search-container hidden">
                                <input id="map-search-input" type="text" placeholder="Search for an address or location" 
                                    class="w-full p-2 border rounded-md text-base bg-gray-700 border-gray-600 text-white shadow-sm">
                            </div>
                        </div>
                        
                        <!-- Category tabs for drawing -->
                        <div class="flex border-b border-gray-600 mt-3 mb-2">
                            <button type="button" id="tab-buildings" class="category-tab px-4 py-2 active">Buildings</button>
                            <button type="button" id="tab-roads" class="category-tab px-4 py-2">Roads/Paved Areas</button>
                            <button type="button" id="tab-land" class="category-tab px-4 py-2">Land/Soil</button>
                        </div>
                        
                        <div class="flex flex-wrap gap-2 mt-2">
                            <button id="draw-polygon" class="px-3 py-2 button-primary text-white text-sm font-medium rounded transition">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 4a2 2 0 114 0v1a1 1 0 001 1h3a1 1 0 011 1v3a1 1 0 01-1 1h-1a2 2 0 100 4h1a1 1 0 011 1v3a1 1 0 01-1 1h-3a1 1 0 01-1-1v-1a2 2 0 10-4 0v1a1 1 0 01-1 1H7a1 1 0 01-1-1v-3a1 1 0 00-1-1H4a2 2 0 110-4h1a1 1 0 001-1V7a1 1 0 011-1h3a1 1 0 001-1V4z" />
                                </svg>
                                Draw Area
                            </button>
                            <button id="clear-drawing" class="px-3 py-2 button-secondary text-white text-sm font-medium rounded transition">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                                Clear Drawing
                            </button>
                            <button id="toggle-search" class="px-3 py-2 button-secondary text-white text-sm font-medium rounded transition ml-auto">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                </svg>
                                Toggle Map Search
                            </button>
                        </div>
                    </div>
                    
                    <div class="area-card rounded-lg p-4">
                        <h3 class="text-lg font-medium mb-3">Saved Areas</h3>
                        
                        <div id="no-areas" class="text-center py-8 text-gray-300">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 mx-auto mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7" />
                            </svg>
                            <p>Draw areas on the map to measure your roofs, roads, or soil surfaces.</p>
                        </div>
                        
                        <div id="area-save-form" class="hidden mb-4">
                            <div class="mb-3">
                                <label class="block text-sm font-medium mb-1">Area Size</label>
                                <div class="text-xl font-bold" id="measured-area">0 sq ft</div>
                            </div>
                            <div class="mb-3">
                                <label for="area-name" class="block text-sm font-medium mb-1">Name this area</label>
                                <input type="text" id="area-name" placeholder="e.g., Main Roof, Driveway" 
                                    class="w-full p-2 border rounded-md text-base bg-gray-700 border-gray-600 text-white">
                            </div>
                            
                            <!-- Building coefficients (default) -->
                            <div id="building-coefficients" class="mb-3">
                                <div class="flex items-center justify-between mb-1">
                                    <label for="building-coefficient" class="block text-sm font-medium">Runoff Coefficient (%)</label>
                                    <div class="tooltip">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-300" viewBox="0 0 20 20" fill="currentColor">
                                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" />
                                        </svg>
                                        <span class="tooltiptext">
                                            <strong>How to choose a value:</strong><br>
                                            - Choose higher values (90-95%) for new, steep metal roofs<br>
                                            - Choose middle values (85-90%) for asphalt shingles in good condition<br>
                                            - Choose lower values (80-85%) for flat or aged roof surfaces<br>
                                            - Consider roof age, slope, and material condition
                                        </span>
                                    </div>
                                </div>
                                <select id="building-coefficient" class="coefficient-select w-full p-2 border rounded-md text-base bg-gray-700 border-gray-600 text-white">
                                    <option value="custom">Custom Value</option>
                                    <option value="95">Metal Roof (95%)</option>
                                    <option value="90" selected>Metal Roof (90%)</option>
                                    <option value="90">Asphalt Shingles (90%)</option>
                                    <option value="85">Asphalt Shingles (85%)</option>
                                    <option value="85">Concrete Tile (85%)</option>
                                    <option value="80">Concrete Tile (80%)</option>
                                    <option value="85">Tar & Gravel (85%)</option>
                                    <option value="80">Tar & Gravel (80%)</option>
                                </select>
                            </div>
                            
                            <!-- Road coefficients (hidden by default) -->
                            <div id="road-coefficients" class="mb-3 hidden">
                                <div class="flex items-center justify-between mb-1">
                                    <label for="road-coefficient" class="block text-sm font-medium">Runoff Coefficient (%)</label>
                                    <div class="tooltip">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-300" viewBox="0 0 20 20" fill="currentColor">
                                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" />
                                        </svg>
                                        <span class="tooltiptext">
                                            <strong>How to choose a value:</strong><br>
                                            - Choose higher values (85-95%) for smooth, sealed pavement with steep slopes<br>
                                            - Choose middle values (75-85%) for standard asphalt or concrete<br>
                                            - Choose lower values (70-75%) for aged, cracked or porous pavement<br>
                                            - For gravel, higher values (50-60%) for compacted sites, lower (40-50%) for loose material
                                        </span>
                                    </div>
                                </div>
                                <select id="road-coefficient" class="coefficient-select w-full p-2 border rounded-md text-base bg-gray-700 border-gray-600 text-white">
                                    <option value="custom">Custom Value</option>
                                    <option value="95">Asphalt/Concrete (95%)</option>
                                    <option value="90">Asphalt/Concrete (90%)</option>
                                    <option value="85">Asphalt/Concrete (85%)</option>
                                    <option value="80">Asphalt/Concrete (80%)</option>
                                    <option value="75">Asphalt/Concrete (75%)</option>
                                    <option value="70" selected>Asphalt/Concrete (70%)</option>
                                    <option value="85">Brick Pavement (85%)</option>
                                    <option value="80">Brick Pavement (80%)</option>
                                    <option value="75">Brick Pavement (75%)</option>
                                    <option value="70">Brick Pavement (70%)</option>
                                    <option value="60">Gravel (60%)</option>
                                    <option value="50">Gravel (50%)</option>
                                    <option value="40">Gravel (40%)</option>
                                </select>
                            </div>
                            
                            <!-- Land coefficients (hidden by default) -->
                            <div id="land-coefficients" class="mb-3 hidden">
                                <div class="flex items-center justify-between mb-1">
                                    <label for="land-coefficient" class="block text-sm font-medium">Runoff Coefficient (%)</label>
                                    <div class="tooltip">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-300" viewBox="0 0 20 20" fill="currentColor">
                                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" />
                                        </svg>
                                        <span class="tooltiptext">
                                            <strong>How to choose a value:</strong><br>
                                            - For bare soil, choose higher values for steep slopes, compacted soil, or after heavy rain<br>
                                            - For vegetated areas, choose higher values for steep slopes, sparse vegetation, or saturated soil<br>
                                            - For lawns, higher values for heavy soils (clay), lower for sandy soils<br>
                                            - Consider steepness of slope, soil type, vegetation density, and soil compaction
                                        </span>
                                    </div>
                                </div>
                                <select id="land-coefficient" class="coefficient-select w-full p-2 border rounded-md text-base bg-gray-700 border-gray-600 text-white">
                                    <option value="custom">Custom Value</option>
                                    <optgroup label="Healthy Lawn">
                                        <option value="20">Sandy Soil (20%)</option>
                                        <option value="10">Sandy Soil (10%)</option>
                                        <option value="5">Sandy Soil (5%)</option>
                                        <option value="35">Heavy Soil (35%)</option>
                                        <option value="25">Heavy Soil (25%)</option>
                                        <option value="13">Heavy Soil (13%)</option>
                                    </optgroup>
                                    <optgroup label="Clay Soil">
                                        <option value="70">Bare (70%)</option>
                                        <option value="60">Bare (60%)</option>
                                        <option value="50" selected>Bare (50%)</option>
                                        <option value="60">Light Vegetation (60%)</option>
                                        <option value="50">Light Vegetation (50%)</option>
                                        <option value="40">Light Vegetation (40%)</option>
                                        <option value="50">High Vegetation (50%)</option>
                                        <option value="40">High Vegetation (40%)</option>
                                        <option value="30">High Vegetation (30%)</option>
                                    </optgroup>
                                    <optgroup label="Loam Soil">
                                        <option value="60">Bare (60%)</option>
                                        <option value="50">Bare (50%)</option>
                                        <option value="40">Bare (40%)</option>
                                        <option value="45">Light Vegetation (45%)</option>
                                        <option value="35">Light Vegetation (35%)</option>
                                        <option value="25">Light Vegetation (25%)</option>
                                        <option value="35">High Vegetation (35%)</option>
                                        <option value="25">High Vegetation (25%)</option>
                                        <option value="15">High Vegetation (15%)</option>
                                    </optgroup>
                                    <optgroup label="Sandy Soil">
                                        <option value="50">Bare (50%)</option>
                                        <option value="40">Bare (40%)</option>
                                        <option value="30">Bare (30%)</option>
                                        <option value="40">Light Vegetation (40%)</option>
                                        <option value="30">Light Vegetation (30%)</option>
                                        <option value="20">Light Vegetation (20%)</option>
                                        <option value="30">High Vegetation (30%)</option>
                                        <option value="20">High Vegetation (20%)</option>
                                        <option value="10">High Vegetation (10%)</option>
                                    </optgroup>
                                </select>
                            </div>
                            
                            <div id="custom-coefficient-container" class="hidden mt-2">
                                <input type="number" id="custom-coefficient" min="1" max="100" value="90" 
                                    class="w-full p-2 border rounded-md text-base bg-gray-700 border-gray-600 text-white">
                            </div>
                            
                            <button id="save-area" class="w-full py-2 px-3 button-primary text-white font-medium rounded-md transition">
                                Save Area
                            </button>
                        </div>
                        
                        <!-- Building Areas -->
                        <div id="building-areas-container" class="mb-4">
                            <h4 class="font-medium text-sm uppercase text-permTan mb-2">Buildings</h4>
                            <ul id="building-areas-list" class="divide-y divide-gray-600 max-h-32 overflow-y-auto">
                                <!-- Building areas will be displayed here -->
                                <li class="no-data-message text-xs italic">No building areas added yet</li>
                            </ul>
                            <div id="building-total" class="mt-2 pt-2 border-t border-gray-600 hidden">
                                <div class="flex justify-between text-sm">
                                    <span>Total Building Area:</span>
                                    <span id="building-area-value" class="font-bold">0 sq ft</span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span>Avg. Runoff Coefficient:</span>
                                    <span id="building-coefficient-value" class="font-bold">0%</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Road Areas -->
                        <div id="road-areas-container" class="mb-4">
                            <h4 class="font-medium text-sm uppercase text-permTan mb-2">Roads/Paved Areas</h4>
                            <ul id="road-areas-list" class="divide-y divide-gray-600 max-h-32 overflow-y-auto">
                                <!-- Road areas will be displayed here -->
                                <li class="no-data-message text-xs italic">No paved areas added yet</li>
                            </ul>
                            <div id="road-total" class="mt-2 pt-2 border-t border-gray-600 hidden">
                                <div class="flex justify-between text-sm">
                                    <span>Total Road Area:</span>
                                    <span id="road-area-value" class="font-bold">0 sq ft</span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span>Avg. Runoff Coefficient:</span>
                                    <span id="road-coefficient-value" class="font-bold">0%</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Land Areas -->
                        <div id="land-areas-container" class="mb-4">
                            <h4 class="font-medium text-sm uppercase text-permTan mb-2">Land/Soil</h4>
                            <ul id="land-areas-list" class="divide-y divide-gray-600 max-h-32 overflow-y-auto">
                                <!-- Land areas will be displayed here -->
                                <li class="no-data-message text-xs italic">No land areas added yet</li>
                            </ul>
                            <div id="land-total" class="mt-2 pt-2 border-t border-gray-600 hidden">
                                <div class="flex justify-between text-sm">
                                    <span>Total Land Area:</span>
                                    <span id="land-area-value" class="font-bold">0 sq ft</span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span>Avg. Runoff Coefficient:</span>
                                    <span id="land-coefficient-value" class="font-bold">0%</span>
                                </div>
                            </div>
                        </div>
                        
                        <div id="total-area" class="mt-4 pt-3 border-t border-gray-600 hidden">
                            <div class="flex justify-between">
                                <span class="font-medium">Total Combined Area:</span>
                                <span id="total-area-value" class="font-bold">0 sq ft</span>
                            </div>
                            <button id="use-in-calculator" class="w-full mt-3 py-2 px-3 button-primary text-white font-medium rounded-md transition">
                                Use in Calculator
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="grid md:grid-cols-2 gap-6">
                <!-- Input Form Section -->
                <div class="panel-card rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-semibold mb-4">Enter Rainfall Information</h2>
                    
                    <form id="calculator-form" class="space-y-5">
                        <!-- Rainfall Data Section -->
                        <div class="border border-gray-600 rounded-lg p-4 mb-4">
                            <h3 class="text-lg font-medium mb-3">Rainfall Data</h3>
                            
                            <!-- Tab Navigation -->
                            <div class="flex border-b border-gray-600 mb-4">
                                <button type="button" id="tab-zipcode" class="tab-btn px-4 py-2 border-b-2 tab-active font-medium">Zip Code</button>
                                <button type="button" id="tab-city" class="tab-btn px-4 py-2 border-b-2 border-transparent hover:text-permButton">City</button>
                                <button type="button" id="tab-custom" class="tab-btn px-4 py-2 border-b-2 border-transparent hover:text-permButton">Custom Data</button>
                            </div>
                            
                            <!-- Zip Code Tab -->
                            <div id="zipcode-tab" class="tab-content">
                                <div class="mb-3">
                                    <label for="zipcode" class="block text-sm font-medium mb-1">Enter Zip Code</label>
                                    <div class="flex">
                                        <input type="text" id="zipcode" placeholder="e.g., 92101" 
                                            class="flex-grow p-3 border rounded-l-md text-base bg-gray-700 border-gray-600 text-white">
                                        <button type="button" id="search-zipcode" class="button-primary text-white px-4 rounded-r-md">
                                            <span>Search</span>
                                        </button>
                                    </div>
                                    <p class="text-xs text-gray-300 mt-1">
                                        Get rainfall data for your specific location.
                                    </p>
                                </div>
                                
                                <div id="zipcode-result" class="hidden">
                                    <div class="flex items-center justify-between">
                                        <h4 class="font-medium" id="zipcode-location">Rainfall Data for: <span id="zipcode-display"></span></h4>
                                        <span class="text-xs text-gray-300">Data source: <span id="data-source">Database</span></span>
                                    </div>
                                    <div class="mt-2">
                                        <div class="flex justify-between text-sm">
                                            <span>Annual Average Rainfall:</span>
                                            <span id="zipcode-annual" class="font-bold"></span>
                                        </div>
                                        <div id="zipcode-loading" class="py-4 flex justify-center">
                                            <div class="spinner"></div>
                                        </div>
                                        <div id="zipcode-data" class="hidden">
                                            <div class="mt-3 text-sm grid grid-cols-3 gap-2">
                                                <!-- Zip code monthly data will be populated here -->
                                            </div>
                                        </div>
                                        <div id="zipcode-error" class="hidden mt-3 text-sm p-3 bg-red-900/20 text-red-300 rounded">
                                            Error fetching rainfall data. Please try again or enter a different location.
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- City Tab -->
                            <div id="city-tab" class="tab-content hidden">
                                <div>
                                    <label for="location" class="block text-sm font-medium mb-1">Select Your Location</label>
                                    <select id="location" name="location"
                                        class="w-full p-3 border rounded-md text-base bg-gray-700 border-gray-600 text-white">
                                        <option value="" disabled selected>Choose a city</option>
                                        <!-- Locations will be populated by JavaScript -->
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Custom Data Tab -->
                            <div id="custom-tab" class="tab-content hidden">
                                <div>
                                    <div class="flex justify-between mb-2">
                                        <label class="block text-sm font-medium">Enter Monthly Rainfall Amounts (inches)</label>
                                        <button type="button" id="reset-custom" class="text-xs text-permButton">Reset Data</button>
                                    </div>
                                    <div class="grid grid-cols-4 gap-2" id="custom-data-inputs">
                                        <!-- Month inputs will be populated by JavaScript -->
                                    </div>
                                    <p class="text-xs text-gray-300 mt-1">
                                        Enter your own rainfall data if you have more accurate local measurements.
                                    </p>
                                </div>
                            </div>
                        </div>

                        <button type="submit" class="w-full py-3 px-4 button-primary text-white font-medium rounded-md transition duration-150 ease-in-out">
                            Calculate Potential
                        </button>
                    </form>
                </div>

                <!-- Results Section -->
                <div class="panel-card rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-semibold mb-4">Rainwater Harvesting Potential</h2>
                    
                    <div id="results-container" class="hidden">
                        <div class="mb-4">
                            <h3 class="text-lg font-medium">Location: <span id="result-location" class="font-normal"></span></h3>
                            <p class="mt-1">Annual Rainfall: <span id="result-annual-rainfall"></span></p>
                        </div>

                        <!-- Summary Cards by Area -->
                        <div id="individual-areas" class="space-y-4 mb-6">
                            <h3 class="text-lg font-medium mb-2">Individual Area Results</h3>
                            <div id="individual-area-list" class="space-y-3 max-h-80 overflow-y-auto pr-1">
                                <!-- Individual area results will be displayed here -->
                            </div>
                        </div>

                        <!-- Results by category -->
                        <div class="space-y-4 mb-6">
                            <h3 class="text-lg font-medium mb-2">Category Totals</h3>

                            <!-- Building results -->
                            <div id="building-results" class="border border-gray-600 rounded-lg p-4 hidden">
                                <h3 class="text-lg font-medium mb-2">Buildings</h3>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <p class="text-sm text-gray-300">Collection Area</p>
                                        <p class="text-lg font-bold" id="result-building-area"></p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-300">Runoff Coefficient</p>
                                        <p class="text-lg font-bold" id="result-building-coefficient"></p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-300">Annual Collection</p>
                                        <p class="text-lg font-bold" id="result-building-gallons"></p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-300">Monthly Average</p>
                                        <p class="text-lg font-bold" id="result-building-monthly"></p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Road results -->
                            <div id="road-results" class="border border-gray-600 rounded-lg p-4 hidden">
                                <h3 class="text-lg font-medium mb-2">Roads/Paved Areas</h3>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <p class="text-sm text-gray-300">Collection Area</p>
                                        <p class="text-lg font-bold" id="result-road-area"></p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-300">Runoff Coefficient</p>
                                        <p class="text-lg font-bold" id="result-road-coefficient"></p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-300">Annual Collection</p>
                                        <p class="text-lg font-bold" id="result-road-gallons"></p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-300">Monthly Average</p>
                                        <p class="text-lg font-bold" id="result-road-monthly"></p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Land results -->
                            <div id="land-results" class="border border-gray-600 rounded-lg p-4 hidden">
                                <h3 class="text-lg font-medium mb-2">Land/Soil</h3>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <p class="text-sm text-gray-300">Collection Area</p>
                                        <p class="text-lg font-bold" id="result-land-area"></p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-300">Runoff Coefficient</p>
                                        <p class="text-lg font-bold" id="result-land-coefficient"></p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-300">Annual Collection</p>
                                        <p class="text-lg font-bold" id="result-land-gallons"></p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-300">Monthly Average</p>
                                        <p class="text-lg font-bold" id="result-land-monthly"></p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Total results -->
                            <div id="total-results" class="bg-permButton/20 border border-permButton rounded-lg p-4">
                                <h3 class="text-lg font-medium mb-2">Total Potential</h3>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <p class="text-sm text-gray-300">Total Area</p>
                                        <p class="text-lg font-bold" id="result-total-area"></p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-300">Avg. Runoff Coefficient</p>
                                        <p class="text-lg font-bold" id="result-total-coefficient"></p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-300">Annual Collection</p>
                                        <p class="text-lg font-bold" id="result-total-gallons"></p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-300">Monthly Average</p>
                                        <p class="text-lg font-bold" id="result-total-monthly"></p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="chart-container">
                            <canvas id="rainfall-chart"></canvas>
                        </div>

                        <div class="overflow-x-auto mt-6">
                            <table class="min-w-full divide-y divide-gray-600">
                                <thead class="bg-gray-700">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Month</th>
                                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-300 uppercase tracking-wider">Rainfall (in)</th>
                                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-300 uppercase tracking-wider">Water Collected (gal)</th>
                                    </tr>
                                </thead>
                                <tbody id="results-table-body" class="divide-y divide-gray-600">
                                    <!-- Results will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div id="no-results" class="text-center py-10">
                        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                        </svg>
                        <h3 class="mt-2 text-lg font-medium text-white">No Calculations Yet</h3>
                        <p class="mt-1 text-sm text-gray-300">Fill out the form to see your rainwater harvesting potential.</p>
                    </div>
                </div>
            </div>
        </main>

        <footer class="bg-permBg py-4 px-4 mt-8 border-t border-gray-600">
            <div class="container mx-auto text-center text-sm text-gray-300">
                <p>This calculator provides estimates based on historical rainfall data. Actual results may vary.</p>
                <p class="mt-1">Â© 2023 The Permaculture Lab</p>
            </div>
        </footer>
    </div>

    <script>
        // Initialize dark mode (not needed for this app since it has a fixed dark theme)
        document.documentElement.classList.add('dark');

        // Map variables
        let map;
        let drawingManager;
        let selectedShape = null;
        let currentPolygon = null;
        let savedAreas = [];
        let polygonsOnMap = new Map(); // Map to store polygons with their IDs
        let editMode = false;
        let editingAreaId = null;
        let currentCategory = 'buildings'; // Default category
        
        // Initialize map 
        function initMap() {
            // Default location (United States)
            const defaultLocation = { lat: 39.8283, lng: -98.5795 };
            
            // Create map with tilt disabled and higher max zoom
            map = new google.maps.Map(document.getElementById('map-container'), {
                center: defaultLocation,
                zoom: 5,
                mapTypeId: 'hybrid', // Use hybrid by default (satellite + roads)
                mapTypeControl: true,
                streetViewControl: false,
                fullscreenControl: true,
                zoomControl: true,
                tilt: 0, // Disable the 45-degree tilt
                scrollwheel: true, // Enable mouse wheel zooming
                maxZoom: 22, // Increased maximum zoom level (default is 20)
                styles: [
                    { elementType: 'geometry', stylers: [{ color: '#242f3e' }] },
                    { elementType: 'labels.text.stroke', stylers: [{ color: '#242f3e' }] },
                    { elementType: 'labels.text.fill', stylers: [{ color: '#746855' }] }
                ]
            });
            
            // Create drawing manager
            drawingManager = new google.maps.drawing.DrawingManager({
                drawingMode: null,
                drawingControl: false,
                polygonOptions: {
                    strokeColor: getColorForCategory(currentCategory, true),
                    strokeOpacity: 0.8,
                    strokeWeight: 2,
                    fillColor: getColorForCategory(currentCategory, true),
                    fillOpacity: 0.35,
                    editable: true
                }
            });
            
            drawingManager.setMap(map);
            
            // Add event listener for when polygon is completed
            google.maps.event.addListener(drawingManager, 'polygoncomplete', function(polygon) {
                // If in edit mode, delete the old polygon first
                if (editMode && currentPolygon) {
                    currentPolygon.setMap(null);
                }
                
                // Set current polygon
                currentPolygon = polygon;
                selectedShape = polygon;
                drawingManager.setDrawingMode(null);
                
                // Calculate area
                const area = google.maps.geometry.spherical.computeArea(polygon.getPath());
                // Convert from square meters to square feet
                const areaInSquareFeet = area * 10.7639;
                
                document.getElementById('measured-area').textContent = Math.round(areaInSquareFeet).toLocaleString() + ' sq ft';
                document.getElementById('area-save-form').classList.remove('hidden');
                document.getElementById('no-areas').classList.add('hidden');
                
                // Pre-fill name field if in edit mode
                if (editMode) {
                    const area = savedAreas.find(a => a.id === editingAreaId);
                    if (area) {
                        document.getElementById('area-name').value = area.name;
                        // Set the coefficient dropdown based on category
                        const coefficientSelect = document.getElementById(`${area.category}-coefficient`);
                        const options = Array.from(coefficientSelect.options);
                        const matchingOption = options.find(option => parseInt(option.value) === area.coefficient);
                        
                        if (matchingOption) {
                            coefficientSelect.value = matchingOption.value;
                        } else {
                            coefficientSelect.value = 'custom';
                            document.getElementById('custom-coefficient').value = area.coefficient;
                            document.getElementById('custom-coefficient-container').classList.remove('hidden');
                        }
                    }
                }
                
                // Add listeners for when the polygon is modified
                google.maps.event.addListener(polygon.getPath(), 'set_at', updateArea);
                google.maps.event.addListener(polygon.getPath(), 'insert_at', updateArea);
                
                function updateArea() {
                    const updatedArea = google.maps.geometry.spherical.computeArea(polygon.getPath());
                    const updatedAreaInSquareFeet = updatedArea * 10.7639;
                    document.getElementById('measured-area').textContent = Math.round(updatedAreaInSquareFeet).toLocaleString() + ' sq ft';
                }
            });
            
            // Set up address search
            const addressInput = document.getElementById('address-input');
            const addressSearchBtn = document.getElementById('address-search-btn');
            
            // Create autocomplete for address input
            const addressAutocomplete = new google.maps.places.Autocomplete(addressInput, {
                types: ['geocode']
            });
            
            // Handle address search
            addressSearchBtn.addEventListener('click', searchAddress);
            addressInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchAddress();
                }
            });
            
            // Handle place selection from autocomplete
            addressAutocomplete.addListener('place_changed', function() {
                const place = addressAutocomplete.getPlace();
                if (!place.geometry || !place.geometry.location) {
                    alert('No details available for the entered address');
                    return;
                }
                
                centerOnPlace(place);
            });
            
            // Set up map search box
            const mapSearchInput = document.getElementById('map-search-input');
            
            // Create map search autocomplete
            const mapSearchAutocomplete = new google.maps.places.Autocomplete(mapSearchInput);
            mapSearchAutocomplete.bindTo('bounds', map);
            
            // Listen for place selection in map search
            mapSearchAutocomplete.addListener('place_changed', function() {
                const place = mapSearchAutocomplete.getPlace();
                
                if (!place.geometry || !place.geometry.location) {
                    alert('No details available for the entered place');
                    return;
                }
                
                centerOnPlace(place);
            });
            
            // Helper function to center on a place
            function centerOnPlace(place) {
                // If the place has a geometry, then present it on a map
                if (place.geometry.viewport) {
                    map.fitBounds(place.geometry.viewport);
                    // After fitting to viewport, zoom in a bit more if needed
                    setTimeout(() => {
                        if (map.getZoom() < 18) map.setZoom(18);
                    }, 300);
                } else {
                    map.setCenter(place.geometry.location);
                    map.setZoom(20); // Close zoom for buildings
                }
            }
            
            function searchAddress() {
                const address = addressInput.value.trim();
                if (!address) return;
                
                const geocoder = new google.maps.Geocoder();
                geocoder.geocode({ address: address }, function(results, status) {
                    if (status === 'OK') {
                        map.setCenter(results[0].geometry.location);
                        map.setZoom(20); // Zoom in more closely
                    } else {
                        alert('Could not find the address: ' + status);
                    }
                });
            }
            
            // Try to get user's location
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    const userLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    map.setCenter(userLocation);
                    map.setZoom(20); // Zoom in to a level where buildings are visible
                }, function() {
                    // Location access denied or error
                    console.log('Unable to get current location.');
                });
            }
        }

        // Helper function to get color based on category and selection state
        function getColorForCategory(category, isSelected) {
            // Selected colors by category
            if (isSelected) {
                if (category === 'buildings') {
                    return '#EC1E7D'; // magenta
                } else if (category === 'roads') {
                    return '#F57C00'; // orange
                } else if (category === 'land') {
                    return '#43A047'; // green
                }
            } else {
                // Unselected colors by category
                if (category === 'buildings') {
                    return '#880E4F'; // dark magenta
                } else if (category === 'roads') {
                    return '#A04000'; // dark orange
                } else if (category === 'land') {
                    return '#1B5E20'; // dark green
                }
            }
            return '#FF0000'; // default red
        }
        
        // Handle category tabs
        document.getElementById('tab-buildings').addEventListener('click', function() {
            setActiveCategory('buildings');
        });
        
        document.getElementById('tab-roads').addEventListener('click', function() {
            setActiveCategory('roads');
        });
        
        document.getElementById('tab-land').addEventListener('click', function() {
            setActiveCategory('land');
        });
        
        function setActiveCategory(category) {
            // Update active tab
            document.querySelectorAll('.category-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.getElementById(`tab-${category}`).classList.add('active');
            
            // Show corresponding coefficient dropdown
            document.querySelectorAll('[id$=-coefficients]').forEach(el => {
                el.classList.add('hidden');
            });
            document.getElementById(`${category}-coefficients`).classList.remove('hidden');
            
            // Update current category
            currentCategory = category;
            
            // Update drawing manager with new colors for this category
            if (drawingManager) {
                drawingManager.setOptions({
                    polygonOptions: {
                        strokeColor: getColorForCategory(category, true),
                        strokeOpacity: 0.8,
                        strokeWeight: 2,
                        fillColor: getColorForCategory(category, true),
                        fillOpacity: 0.35,
                        editable: true
                    }
                });
            }
        }
        
        // Handle coefficient select change for all coefficient dropdowns
        document.querySelectorAll('.coefficient-select').forEach(select => {
            select.addEventListener('change', function() {
                const customContainer = document.getElementById('custom-coefficient-container');
                if (this.value === 'custom') {
                    customContainer.classList.remove('hidden');
                } else {
                    customContainer.classList.add('hidden');
                }
            });
        });
        
        // Handle map action buttons
        document.getElementById('draw-polygon').addEventListener('click', function() {
            // Exit edit mode if active
            editMode = false;
            editingAreaId = null;
            
            clearCurrentDrawing();
            drawingManager.setDrawingMode(google.maps.drawing.OverlayType.POLYGON);
        });
        
        document.getElementById('clear-drawing').addEventListener('click', clearCurrentDrawing);
        
        // Toggle search box
        document.getElementById('toggle-search').addEventListener('click', function() {
            const searchBox = document.querySelector('.map-search-container');
            searchBox.classList.toggle('hidden');
        });
        
        function clearCurrentDrawing() {
            if (currentPolygon) {
                currentPolygon.setMap(null);
                currentPolygon = null;
            }
            document.getElementById('area-save-form').classList.add('hidden');
            if (savedAreas.length === 0) {
                document.getElementById('no-areas').classList.remove('hidden');
            }
            document.getElementById('area-name').value = '';
            drawingManager.setDrawingMode(null);
        }
        
        // Save area
        document.getElementById('save-area').addEventListener('click', function() {
            const areaName = document.getElementById('area-name').value.trim();
            
            if (!areaName) {
                alert('Please enter a name for this area.');
                return;
            }
            
            if (!currentPolygon) {
                alert('No area has been drawn on the map.');
                return;
            }
            
            // Get the coefficient value based on current category
            let coefficient;
            const coefficientSelect = document.getElementById(`${currentCategory}-coefficient`);
            if (coefficientSelect.value === 'custom') {
                coefficient = parseInt(document.getElementById('custom-coefficient').value);
                if (isNaN(coefficient) || coefficient < 1 || coefficient > 100) {
                    alert('Please enter a valid runoff coefficient between 1 and 100.');
                    return;
                }
            } else {
                coefficient = parseInt(coefficientSelect.value);
            }
            
            // Calculate area
            const area = google.maps.geometry.spherical.computeArea(currentPolygon.getPath());
            const areaInSquareFeet = area * 10.7639;
            
            // Save the polygon's path coordinates (needed to recreate the polygon later)
            const pathArray = [];
            for (let i = 0; i < currentPolygon.getPath().getLength(); i++) {
                const point = currentPolygon.getPath().getAt(i);
                pathArray.push({ lat: point.lat(), lng: point.lng() });
            }
            
            if (editMode && editingAreaId) {
                // Update existing area
                const areaIndex = savedAreas.findIndex(a => a.id === editingAreaId);
                if (areaIndex !== -1) {
                    // Update the area info
                    savedAreas[areaIndex].name = areaName;
                    savedAreas[areaIndex].area = areaInSquareFeet;
                    savedAreas[areaIndex].pathCoordinates = pathArray;
                    savedAreas[areaIndex].coefficient = coefficient;
                    savedAreas[areaIndex].category = currentCategory;
                    
                    // Update the polygon on the map
                    if (polygonsOnMap.has(editingAreaId)) {
                        polygonsOnMap.get(editingAreaId).setMap(null);
                    }
                    
                    createPolygonOnMap(editingAreaId, pathArray, savedAreas[areaIndex].selected, currentCategory);
                }
                
                // Reset edit mode
                editMode = false;
                editingAreaId = null;
            } else {
                // Create new saved area
                const newId = Date.now().toString();
                
                // Create saved area object
                const savedArea = {
                    id: newId,
                    name: areaName,
                    area: areaInSquareFeet,
                    pathCoordinates: pathArray,
                    coefficient: coefficient,
                    category: currentCategory,
                    selected: true // Auto-select new areas
                };
                
                // Add to saved areas array
                savedAreas.push(savedArea);
                
                // Add the polygon to the map
                createPolygonOnMap(newId, pathArray, true, currentCategory);
            }
            
            // Update UI
            renderSavedAreasList();
            updateAreaTotals();
            
            // Clear current drawing and form
            currentPolygon.setMap(null);
            currentPolygon = null;
            document.getElementById('area-name').value = '';
            document.getElementById('custom-coefficient-container').classList.add('hidden');
            document.getElementById('area-save-form').classList.add('hidden');
            
            // Show the saved areas
            document.getElementById('total-area').classList.remove('hidden');
        });
        
        // Helper function to create a polygon on the map
        function createPolygonOnMap(id, pathCoordinates, isSelected, category) {
            // Get color based on category and selection state
            const fillColor = getColorForCategory(category, isSelected);
            const strokeColor = getColorForCategory(category, isSelected);
            
            const polygon = new google.maps.Polygon({
                paths: pathCoordinates,
                strokeColor: strokeColor,
                strokeOpacity: 0.8,
                strokeWeight: 2,
                fillColor: fillColor,
                fillOpacity: 0.35,
                editable: false,
                map: map
            });
            
            // Store the polygon with its ID
            polygonsOnMap.set(id, polygon);
            
            // Add click event to select this polygon
            google.maps.event.addListener(polygon, 'click', function() {
                const area = savedAreas.find(a => a.id === id);
                if (area) {
                    showAreaOnMap(id);
                }
            });
            
            return polygon;
        }
        
        // Render the list of saved areas by category
        function renderSavedAreasList() {
            // Clear all lists
            document.getElementById('building-areas-list').innerHTML = '';
            document.getElementById('road-areas-list').innerHTML = '';
            document.getElementById('land-areas-list').innerHTML = '';
            
            // Reset area totals display
            document.getElementById('building-total').classList.add('hidden');
            document.getElementById('road-total').classList.add('hidden');
            document.getElementById('land-total').classList.add('hidden');
            
            // Group areas by category
            const buildingAreas = savedAreas.filter(a => a.category === 'buildings');
            const roadAreas = savedAreas.filter(a => a.category === 'roads');
            const landAreas = savedAreas.filter(a => a.category === 'land');
            
            // Render building areas
            if (buildingAreas.length > 0) {
                renderAreaList(buildingAreas, 'building-areas-list');
            } else {
                document.getElementById('building-areas-list').innerHTML = 
                    '<li class="no-data-message text-xs italic">No building areas added yet</li>';
            }
            
            // Render road areas
            if (roadAreas.length > 0) {
                renderAreaList(roadAreas, 'road-areas-list');
            } else {
                document.getElementById('road-areas-list').innerHTML = 
                    '<li class="no-data-message text-xs italic">No paved areas added yet</li>';
            }
            
            // Render land areas
            if (landAreas.length > 0) {
                renderAreaList(landAreas, 'land-areas-list');
            } else {
                document.getElementById('land-areas-list').innerHTML = 
                    '<li class="no-data-message text-xs italic">No land areas added yet</li>';
            }
            
            // Update visibility of sections based on whether they have areas
            document.getElementById('building-total').classList.toggle('hidden', buildingAreas.length === 0);
            document.getElementById('road-total').classList.toggle('hidden', roadAreas.length === 0);
            document.getElementById('land-total').classList.toggle('hidden', landAreas.length === 0);
            
            // Show/hide total area section
            document.getElementById('total-area').classList.toggle('hidden', savedAreas.length === 0);
        }
        
        // Helper function to render a list of areas
        function renderAreaList(areas, listId) {
            const listElement = document.getElementById(listId);
            listElement.innerHTML = ''; // Clear existing content
            
            areas.forEach(area => {
                const listItem = document.createElement('li');
                listItem.className = `area-list-item py-3 px-2 flex justify-between items-center ${area.selected ? 'selected' : ''}`;
                listItem.dataset.id = area.id;
                
                listItem.innerHTML = `
                    <div>
                        <div class="font-medium">${area.name}</div>
                        <div class="text-sm text-gray-300">
                            ${Math.round(area.area).toLocaleString()} sq ft Â· ${area.coefficient}% runoff
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button class="select-btn p-1 text-gray-300 hover:text-permButton" title="Select/Deselect">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                            </svg>
                        </button>
                        <button class="edit-btn p-1 text-gray-300 hover:text-blue-400" title="Edit">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" />
                            </svg>
                        </button>
                        <button class="delete-btn p-1 text-gray-300 hover:text-red-400" title="Delete">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>
                `;
                
                listElement.appendChild(listItem);
            });
            
            // Add event listeners to all buttons in this list
            const buttons = listElement.querySelectorAll('button');
            buttons.forEach(btn => {
                const id = btn.closest('.area-list-item').dataset.id;
                
                if (btn.classList.contains('select-btn')) {
                    btn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        toggleAreaSelection(id);
                    });
                } else if (btn.classList.contains('edit-btn')) {
                    btn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        editArea(id);
                    });
                } else if (btn.classList.contains('delete-btn')) {
                    btn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        deleteArea(id);
                    });
                }
            });
            
            // Add click event to show area on map
            listElement.querySelectorAll('.area-list-item').forEach(item => {
                item.addEventListener('click', function() {
                    showAreaOnMap(this.dataset.id);
                });
            });
        }
        
        // Edit area
        function editArea(id) {
            // Find the area to edit
            const area = savedAreas.find(a => a.id === id);
            if (!area) return;
            
            // Set edit mode
            editMode = true;
            editingAreaId = id;
            
            // Switch to the area's category
            setActiveCategory(area.category);
            
            // Create editable polygon from saved coordinates
            if (currentPolygon) {
                currentPolygon.setMap(null);
            }
            
            currentPolygon = new google.maps.Polygon({
                paths: area.pathCoordinates,
                strokeColor: getColorForCategory(area.category, true),
                strokeOpacity: 0.8,
                strokeWeight: 2,
                fillColor: getColorForCategory(area.category, true),
                fillOpacity: 0.35,
                editable: true,
                map: map
            });
            
            // Add listeners for when the polygon is modified
            google.maps.event.addListener(currentPolygon.getPath(), 'set_at', updateArea);
            google.maps.event.addListener(currentPolygon.getPath(), 'insert_at', updateArea);
            
            function updateArea() {
                const updatedArea = google.maps.geometry.spherical.computeArea(currentPolygon.getPath());
                const updatedAreaInSquareFeet = updatedArea * 10.7639;
                document.getElementById('measured-area').textContent = Math.round(updatedAreaInSquareFeet).toLocaleString() + ' sq ft';
            }
            
            // Show form with pre-filled values
            document.getElementById('area-name').value = area.name;
            document.getElementById('measured-area').textContent = Math.round(area.area).toLocaleString() + ' sq ft';
            
            // Set the appropriate coefficient
            const coefficientSelect = document.getElementById(`${area.category}-coefficient`);
            const options = Array.from(coefficientSelect.options);
            const matchingOption = options.find(option => parseInt(option.value) === area.coefficient);
            
            if (matchingOption) {
                coefficientSelect.value = matchingOption.value;
                document.getElementById('custom-coefficient-container').classList.add('hidden');
            } else {
                coefficientSelect.value = 'custom';
                document.getElementById('custom-coefficient').value = area.coefficient;
                document.getElementById('custom-coefficient-container').classList.remove('hidden');
            }
            
            document.getElementById('area-save-form').classList.remove('hidden');
            
            // Center map on the polygon
            const bounds = new google.maps.LatLngBounds();
            area.pathCoordinates.forEach(point => bounds.extend(point));
            map.fitBounds(bounds);
        }
        
        // Toggle area selection
        function toggleAreaSelection(id) {
            const area = savedAreas.find(a => a.id === id);
            if (area) {
                area.selected = !area.selected;
                
                // Update the polygon color on the map
                if (polygonsOnMap.has(id)) {
                    // Get selected state and category for color
                    const polygon = polygonsOnMap.get(id);
                    const fillColor = getColorForCategory(area.category, area.selected);
                    const strokeColor = getColorForCategory(area.category, area.selected);
                    
                    polygon.setOptions({
                        strokeColor: strokeColor,
                        fillColor: fillColor
                    });
                }
                
                renderSavedAreasList();
                updateAreaTotals();
            }
        }
        
        // Delete an area
        function deleteArea(id) {
            // Remove the polygon from the map
            if (polygonsOnMap.has(id)) {
                polygonsOnMap.get(id).setMap(null);
                polygonsOnMap.delete(id);
            }
            
            savedAreas = savedAreas.filter(a => a.id !== id);
            renderSavedAreasList();
            updateAreaTotals();
            
            if (savedAreas.length === 0) {
                document.getElementById('no-areas').classList.remove('hidden');
                document.getElementById('total-area').classList.add('hidden');
            }
        }
        
        // Show area on map
        function showAreaOnMap(id) {
            const area = savedAreas.find(a => a.id === id);
            
            if (area) {
                // Center map on polygon
                const bounds = new google.maps.LatLngBounds();
                area.pathCoordinates.forEach(point => bounds.extend(point));
                map.fitBounds(bounds);
            }
        }
        
        // Update area totals
        function updateAreaTotals() {
            // Group selected areas by category
            const buildingAreas = savedAreas.filter(a => a.category === 'buildings' && a.selected);
            const roadAreas = savedAreas.filter(a => a.category === 'roads' && a.selected);
            const landAreas = savedAreas.filter(a => a.category === 'land' && a.selected);
            
            // Calculate building totals
            const buildingTotalArea = buildingAreas.reduce((sum, area) => sum + area.area, 0);
            const buildingWeightedCoefficient = buildingTotalArea > 0 
                ? buildingAreas.reduce((sum, area) => sum + (area.area * area.coefficient), 0) / buildingTotalArea 
                : 0;
            
            // Calculate road totals
            const roadTotalArea = roadAreas.reduce((sum, area) => sum + area.area, 0);
            const roadWeightedCoefficient = roadTotalArea > 0 
                ? roadAreas.reduce((sum, area) => sum + (area.area * area.coefficient), 0) / roadTotalArea 
                : 0;
            
            // Calculate land totals
            const landTotalArea = landAreas.reduce((sum, area) => sum + area.area, 0);
            const landWeightedCoefficient = landTotalArea > 0 
                ? landAreas.reduce((sum, area) => sum + (area.area * area.coefficient), 0) / landTotalArea 
                : 0;
            
            // Calculate grand total of all selected areas
            const allSelectedAreas = savedAreas.filter(a => a.selected);
            const totalArea = allSelectedAreas.reduce((sum, area) => sum + area.area, 0);
            const weightedCoefficient = totalArea > 0 
                ? allSelectedAreas.reduce((sum, area) => sum + (area.area * area.coefficient), 0) / totalArea 
                : 0;
            
            // Update UI for buildings
            document.getElementById('building-area-value').textContent = Math.round(buildingTotalArea).toLocaleString() + ' sq ft';
            document.getElementById('building-coefficient-value').textContent = Math.round(buildingWeightedCoefficient) + '%';
            
            // Update UI for roads
            document.getElementById('road-area-value').textContent = Math.round(roadTotalArea).toLocaleString() + ' sq ft';
            document.getElementById('road-coefficient-value').textContent = Math.round(roadWeightedCoefficient) + '%';
            
            // Update UI for land
            document.getElementById('land-area-value').textContent = Math.round(landTotalArea).toLocaleString() + ' sq ft';
            document.getElementById('land-coefficient-value').textContent = Math.round(landWeightedCoefficient) + '%';
            
            // Update UI for total
            document.getElementById('total-area-value').textContent = Math.round(totalArea).toLocaleString() + ' sq ft';
        }
        
        // Use selected areas in calculator
        document.getElementById('use-in-calculator').addEventListener('click', function() {
            // Calculate rainfall amounts for all categories
            calculateRainwaterPotential();
        });

        // Monthly rainfall data for various cities (inches)
        const rainfallData = {
            "Seattle, WA": [5.57, 3.50, 3.75, 2.71, 1.94, 1.57, 0.70, 0.88, 1.50, 3.48, 5.90, 5.35],
            "Portland, OR": [5.43, 3.89, 3.56, 2.39, 2.06, 1.49, 0.64, 0.67, 1.47, 2.91, 5.27, 6.08],
            "San Francisco, CA": [4.50, 4.05, 3.25, 1.22, 0.49, 0.16, 0.00, 0.06, 0.20, 1.12, 2.40, 4.03],
            "Los Angeles, CA": [3.12, 3.80, 2.43, 0.91, 0.26, 0.09, 0.01, 0.04, 0.24, 0.58, 1.01, 2.33],
            "San Diego, CA": [2.28, 2.04, 1.81, 0.78, 0.12, 0.07, 0.03, 0.01, 0.15, 0.57, 1.01, 1.53],
            "Phoenix, AZ": [0.91, 0.92, 1.07, 0.24, 0.17, 0.06, 0.99, 0.94, 0.75, 0.59, 0.73, 0.92],
            "Denver, CO": [0.49, 0.48, 1.29, 1.71, 2.32, 1.56, 2.16, 1.82, 1.14, 1.13, 0.75, 0.47],
            "Dallas, TX": [2.06, 2.67, 3.49, 3.06, 4.90, 3.53, 2.10, 1.94, 2.52, 4.22, 2.67, 2.57],
            "Houston, TX": [3.70, 3.32, 3.28, 3.58, 5.15, 5.93, 3.18, 3.83, 4.33, 4.50, 4.34, 3.74],
            "Chicago, IL": [1.75, 1.70, 2.50, 3.38, 3.68, 4.15, 3.70, 4.90, 3.21, 3.24, 3.00, 2.43],
            "New York, NY": [3.65, 3.09, 4.36, 4.50, 4.19, 4.41, 4.60, 4.44, 4.28, 4.40, 4.02, 4.00],
            "Miami, FL": [2.22, 2.32, 2.38, 3.36, 6.36, 9.80, 6.45, 8.63, 8.92, 6.41, 3.47, 2.09],
            "Atlanta, GA": [5.02, 4.68, 5.38, 4.30, 3.95, 3.63, 5.27, 3.63, 4.09, 3.11, 4.10, 4.17],
            "Boston, MA": [3.92, 3.47, 4.32, 3.74, 3.49, 3.68, 3.43, 3.35, 3.47, 4.33, 3.95, 4.13],
            "Minneapolis, MN": [0.90, 0.77, 1.89, 2.66, 3.36, 4.25, 4.04, 4.30, 2.89, 2.43, 1.77, 1.16],
            "Kansas City, MO": [1.17, 1.41, 2.71, 3.69, 5.23, 5.17, 4.46, 3.91, 4.62, 3.51, 2.14, 1.53]
        };

        // San Diego County and other locations with rainfall data
        const locationData = {
            // Exact zip codes
            "92082": { // Valley Center
                name: "Valley Center, CA",
                annual: 17.04,
                monthly: [3.39, 4.12, 2.75, 1.29, 0.45, 0.10, 0.12, 0.06, 0.24, 0.73, 1.28, 2.51]
            },
            "92101": { // Downtown San Diego
                name: "Downtown San Diego, CA",
                annual: 10.34,
                monthly: [2.28, 2.04, 1.81, 0.78, 0.12, 0.07, 0.03, 0.01, 0.15, 0.57, 1.01, 1.47]
            },
            "92067": { // Rancho Santa Fe
                name: "Rancho Santa Fe, CA",
                annual: 13.18,
                monthly: [2.89, 2.52, 2.21, 1.02, 0.24, 0.11, 0.06, 0.05, 0.28, 0.74, 1.34, 1.72]
            },
            "91901": { // Alpine (East County)
                name: "Alpine, CA",
                annual: 15.82,
                monthly: [3.42, 3.15, 2.65, 1.24, 0.32, 0.15, 0.08, 0.06, 0.36, 0.88, 1.54, 1.97]
            }
        };

        const months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
        let rainfallChart = null;
        let currentRainfallData = null;

        // Populate location dropdown
        const locationSelect = document.getElementById('location');
        Object.keys(rainfallData).sort().forEach(city => {
            const option = document.createElement('option');
            option.value = city;
            option.textContent = city;
            locationSelect.appendChild(option);
        });

        // Create custom data inputs
        const customDataContainer = document.getElementById('custom-data-inputs');
        months.forEach((month, index) => {
            const inputGroup = document.createElement('div');
            inputGroup.innerHTML = `
                <label class="block text-xs font-medium mb-1">${month}</label>
                <input type="number" id="custom-${index}" class="w-full p-2 border rounded-md text-base bg-gray-700 border-gray-600 text-white" step="0.01" min="0" placeholder="0.00">
            `;
            customDataContainer.appendChild(inputGroup);
        });

        // Handle tab switching
        document.querySelectorAll('.tab-btn').forEach(button => {
            button.addEventListener('click', function() {
                // Update tab buttons
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.classList.remove('tab-active');
                    btn.classList.add('border-transparent');
                });
                this.classList.add('tab-active');
                this.classList.remove('border-transparent');
                
                // Show appropriate tab content
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.add('hidden');
                });
                const targetId = this.id.replace('tab-', '') + '-tab';
                document.getElementById(targetId).classList.remove('hidden');
            });
        });

        // Reset custom data
        document.getElementById('reset-custom').addEventListener('click', function() {
            document.querySelectorAll('#custom-data-inputs input').forEach(input => {
                input.value = '';
            });
        });

        // Handle zip code search
        document.getElementById('search-zipcode').addEventListener('click', searchZipCode);
        document.getElementById('zipcode').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchZipCode();
            }
        });
        
        function searchZipCode() {
            const zipcode = document.getElementById('zipcode').value.trim();
            
            if (!zipcode) {
                alert('Please enter a zip code.');
                return;
            }
            
            // Show loading state
            document.getElementById('zipcode-result').classList.remove('hidden');
            document.getElementById('zipcode-loading').classList.remove('hidden');
            document.getElementById('zipcode-data').classList.add('hidden');
            document.getElementById('zipcode-error').classList.add('hidden');
            document.getElementById('zipcode-display').textContent = zipcode;
            
            // First check our local data
            if (zipcode in locationData) {
                const data = locationData[zipcode];
                document.getElementById('data-source').textContent = 'Local Database';
                displayRainfallData(data.name, data.annual, data.monthly);
                
                // Center map on location if possible
                const geocoder = new google.maps.Geocoder();
                geocoder.geocode({ address: zipcode }, function(results, status) {
                    if (status === 'OK') {
                        map.setCenter(results[0].geometry.location);
                        map.setZoom(20);
                    }
                });
                
                return;
            }
            
            // If not in local data, get location coordinates from zipcode
            const geocoder = new google.maps.Geocoder();
            geocoder.geocode({ address: zipcode }, function(results, status) {
                if (status === 'OK') {
                    const location = results[0].geometry.location;
                    const formattedAddress = results[0].formatted_address;
                    
                    // Set map center
                    map.setCenter(location);
                    map.setZoom(20);
                    
                    // For this demo, we'll use a nearby city's data since we can't do a real API call
                    // In a real app, you would make an API call to a weather service here
                    // Find the closest city in our rainfallData list
                    let closestCity = null;
                    let minDistance = Infinity;
                    
                    Object.keys(rainfallData).forEach(city => {
                        // This is a very rough distance calculation that would be replaced
                        // with a proper API call in a real application
                        const cityLat = {
                            "Seattle, WA": 47.6062,
                            "Portland, OR": 45.5152,
                            "San Francisco, CA": 37.7749,
                            "Los Angeles, CA": 34.0522,
                            "San Diego, CA": 32.7157,
                            "Phoenix, AZ": 33.4484,
                            "Denver, CO": 39.7392,
                            "Dallas, TX": 32.7767,
                            "Houston, TX": 29.7604,
                            "Chicago, IL": 41.8781,
                            "New York, NY": 40.7128,
                            "Miami, FL": 25.7617,
                            "Atlanta, GA": 33.7490,
                            "Boston, MA": 42.3601,
                            "Minneapolis, MN": 44.9778,
                            "Kansas City, MO": 39.0997
                        }[city] || 0;
                        
                        const cityLng = {
                            "Seattle, WA": -122.3321,
                            "Portland, OR": -122.6784,
                            "San Francisco, CA": -122.4194,
                            "Los Angeles, CA": -118.2437,
                            "San Diego, CA": -117.1611,
                            "Phoenix, AZ": -112.0740,
                            "Denver, CO": -104.9903,
                            "Dallas, TX": -96.7970,
                            "Houston, TX": -95.3698,
                            "Chicago, IL": -87.6298,
                            "New York, NY": -74.0060,
                            "Miami, FL": -80.1918,
                            "Atlanta, GA": -84.3880,
                            "Boston, MA": -71.0589,
                            "Minneapolis, MN": -93.2650,
                            "Kansas City, MO": -94.5786
                        }[city] || 0;
                        
                        const distance = Math.sqrt(
                            Math.pow(cityLat - location.lat(), 2) + 
                            Math.pow(cityLng - location.lng(), 2)
                        );
                        
                        if (distance < minDistance) {
                            minDistance = distance;
                            closestCity = city;
                        }
                    });
                    
                    if (closestCity) {
                        document.getElementById('data-source').textContent = 'Estimated from nearest city: ' + closestCity;
                        const monthlyData = rainfallData[closestCity];
                        const annualTotal = monthlyData.reduce((sum, val) => sum + val, 0);
                        displayRainfallData(formattedAddress, annualTotal, monthlyData);
                    } else {
                        throw new Error('Unable to determine rainfall data for this location.');
                    }
                } else {
                    throw new Error('Zip code not found. Please enter a valid US zip code.');
                }
            });
        }
        
        // Display the rainfall data on the UI
        function displayRainfallData(locationName, annualTotal, monthlyData) {
            document.getElementById('zipcode-loading').classList.add('hidden');
            document.getElementById('zipcode-data').classList.remove('hidden');
            
            document.getElementById('zipcode-display').textContent = locationName;
            document.getElementById('zipcode-annual').textContent = annualTotal.toFixed(2) + " inches";
            
            // Display monthly data
            const zipCodeDataContainer = document.getElementById('zipcode-data');
            zipCodeDataContainer.innerHTML = '';
            
            months.forEach((month, index) => {
                const monthlyElement = document.createElement('div');
                monthlyElement.className = 'text-center p-2 bg-gray-600 rounded';
                monthlyElement.innerHTML = `
                    <div class="font-medium">${month.substring(0, 3)}</div>
                    <div>${monthlyData[index].toFixed(2)}"</div>
                `;
                zipCodeDataContainer.appendChild(monthlyElement);
            });
            
            // Save the data for calculations
            currentRainfallData = monthlyData;
        }

        // Form submission handler
        document.getElementById('calculator-form').addEventListener('submit', function(e) {
            e.preventDefault();
            calculateRainwaterPotential();
        });
        
        // Calculate rainwater potential
        function calculateRainwaterPotential() {
            // Determine which rainfall data to use based on active tab
            let monthlyRainfall = null;
            let locationName = "";
            
            const zipCodeTab = !document.getElementById('zipcode-tab').classList.contains('hidden');
            const cityTab = !document.getElementById('city-tab').classList.contains('hidden');
            const customTab = !document.getElementById('custom-tab').classList.contains('hidden');
            
            if (zipCodeTab && currentRainfallData) {
                monthlyRainfall = currentRainfallData;
                locationName = document.getElementById('zipcode-display').textContent;
            } else if (cityTab) {
                const location = document.getElementById('location').value;
                if (!location) {
                    alert('Please select a city from the dropdown.');
                    return;
                }
                monthlyRainfall = rainfallData[location];
                locationName = location;
            } else if (customTab) {
                // Collect values from custom inputs
                monthlyRainfall = [];
                let hasValue = false;
                
                for (let i = 0; i < 12; i++) {
                    const value = parseFloat(document.getElementById(`custom-${i}`).value) || 0;
                    monthlyRainfall.push(value);
                    if (value > 0) hasValue = true;
                }
                
                if (!hasValue) {
                    alert('Please enter at least one monthly rainfall value.');
                    return;
                }
                
                locationName = "Custom Data";
            } else {
                alert('Please select a data source for rainfall information.');
                return;
            }
            
            // Calculate for selected areas
            const selectedAreas = savedAreas.filter(a => a.selected);
            if (selectedAreas.length === 0) {
                alert('Please select at least one area from the saved areas list.');
                return;
            }
            
            // Calculate totals for each category
            const totalRainfall = monthlyRainfall.reduce((sum, inches) => sum + inches, 0);
            
            // Group selected areas by category
            const buildingAreas = selectedAreas.filter(a => a.category === 'buildings');
            const roadAreas = selectedAreas.filter(a => a.category === 'roads');
            const landAreas = selectedAreas.filter(a => a.category === 'land');
            
            // Individual area calculations
            const individualResults = selectedAreas.map(area => {
                const coefficient = area.coefficient / 100;
                const gallons = totalRainfall * area.area * 0.623 * coefficient;
                const monthlyGallons = monthlyRainfall.map(inches => 
                    inches * area.area * 0.623 * coefficient
                );
                
                return {
                    id: area.id,
                    name: area.name,
                    category: area.category,
                    area: area.area,
                    coefficient: area.coefficient,
                    gallons: gallons,
                    monthlyAvg: gallons / 12,
                    monthlyGallons: monthlyGallons
                };
            });
            
            // Building calculations
            const buildingArea = buildingAreas.reduce((sum, area) => sum + area.area, 0);
            const buildingCoeff = buildingArea > 0 
                ? buildingAreas.reduce((sum, area) => sum + (area.area * area.coefficient), 0) / buildingArea / 100
                : 0;
            const buildingGallons = totalRainfall * buildingArea * 0.623 * buildingCoeff;
            
            // Road calculations
            const roadArea = roadAreas.reduce((sum, area) => sum + area.area, 0);
            const roadCoeff = roadArea > 0 
                ? roadAreas.reduce((sum, area) => sum + (area.area * area.coefficient), 0) / roadArea / 100
                : 0;
            const roadGallons = totalRainfall * roadArea * 0.623 * roadCoeff;
            
            // Land calculations
            const landArea = landAreas.reduce((sum, area) => sum + area.area, 0);
            const landCoeff = landArea > 0 
                ? landAreas.reduce((sum, area) => sum + (area.area * area.coefficient), 0) / landArea / 100
                : 0;
            const landGallons = totalRainfall * landArea * 0.623 * landCoeff;
            
            // Total calculations
            const totalArea = buildingArea + roadArea + landArea;
            const weightedCoeff = totalArea > 0
                ? (buildingArea * buildingCoeff + roadArea * roadCoeff + landArea * landCoeff) / totalArea
                : 0;
            const totalGallons = buildingGallons + roadGallons + landGallons;
            
            // Calculate monthly collections for chart and table
            const buildingMonthly = monthlyRainfall.map(inches => inches * buildingArea * 0.623 * buildingCoeff);
            const roadMonthly = monthlyRainfall.map(inches => inches * roadArea * 0.623 * roadCoeff);
            const landMonthly = monthlyRainfall.map(inches => inches * landArea * 0.623 * landCoeff);
            const totalMonthly = monthlyRainfall.map((inches, i) => 
                buildingMonthly[i] + roadMonthly[i] + landMonthly[i]
            );
            
            // Display results
            displayResults(
                locationName, 
                totalRainfall, 
                {
                    buildingArea,
                    buildingCoeff: buildingCoeff * 100,
                    buildingGallons,
                    roadArea,
                    roadCoeff: roadCoeff * 100,
                    roadGallons,
                    landArea,
                    landCoeff: landCoeff * 100,
                    landGallons,
                    totalArea,
                    totalCoeff: weightedCoeff * 100,
                    totalGallons
                },
                monthlyRainfall,
                totalMonthly,
                individualResults
            );
        }

        function displayResults(location, totalRainfall, areas, monthlyRainfall, monthlyCollection, individualResults) {
            // Show results container and hide the placeholder
            document.getElementById('no-results').classList.add('hidden');
            document.getElementById('results-container').classList.remove('hidden');
            
            // Update location and rainfall info
            document.getElementById('result-location').textContent = location;
            document.getElementById('result-annual-rainfall').textContent = `${totalRainfall.toFixed(1)} inches`;
            
            // Show/hide category result sections based on if they have area
            document.getElementById('building-results').classList.toggle('hidden', areas.buildingArea <= 0);
            document.getElementById('road-results').classList.toggle('hidden', areas.roadArea <= 0);
            document.getElementById('land-results').classList.toggle('hidden', areas.landArea <= 0);
            
            // Update building results
            if (areas.buildingArea > 0) {
                document.getElementById('result-building-area').textContent = `${Math.round(areas.buildingArea).toLocaleString()} sq ft`;
                document.getElementById('result-building-coefficient').textContent = `${Math.round(areas.buildingCoeff)}%`;
                document.getElementById('result-building-gallons').textContent = `${Math.round(areas.buildingGallons).toLocaleString()} gallons`;
                document.getElementById('result-building-monthly').textContent = `${Math.round(areas.buildingGallons / 12).toLocaleString()} gallons`;
            }
            
            // Update road results
            if (areas.roadArea > 0) {
                document.getElementById('result-road-area').textContent = `${Math.round(areas.roadArea).toLocaleString()} sq ft`;
                document.getElementById('result-road-coefficient').textContent = `${Math.round(areas.roadCoeff)}%`;
                document.getElementById('result-road-gallons').textContent = `${Math.round(areas.roadGallons).toLocaleString()} gallons`;
                document.getElementById('result-road-monthly').textContent = `${Math.round(areas.roadGallons / 12).toLocaleString()} gallons`;
            }
            
            // Update land results
            if (areas.landArea > 0) {
                document.getElementById('result-land-area').textContent = `${Math.round(areas.landArea).toLocaleString()} sq ft`;
                document.getElementById('result-land-coefficient').textContent = `${Math.round(areas.landCoeff)}%`;
                document.getElementById('result-land-gallons').textContent = `${Math.round(areas.landGallons).toLocaleString()} gallons`;
                document.getElementById('result-land-monthly').textContent = `${Math.round(areas.landGallons / 12).toLocaleString()} gallons`;
            }
            
            // Update total results
            document.getElementById('result-total-area').textContent = `${Math.round(areas.totalArea).toLocaleString()} sq ft`;
            document.getElementById('result-total-coefficient').textContent = `${Math.round(areas.totalCoeff)}%`;
            document.getElementById('result-total-gallons').textContent = `${Math.round(areas.totalGallons).toLocaleString()} gallons`;
            document.getElementById('result-total-monthly').textContent = `${Math.round(areas.totalGallons / 12).toLocaleString()} gallons`;
            
            // Display individual area results
            const individualAreaList = document.getElementById('individual-area-list');
            individualAreaList.innerHTML = '';
            
            individualResults.forEach(result => {
                // Determine category for styling
                let categoryClass = '';
                if (result.category === 'buildings') categoryClass = 'building';
                else if (result.category === 'roads') categoryClass = 'road';
                else if (result.category === 'land') categoryClass = 'land';
                
                const areaCard = document.createElement('div');
                areaCard.className = `result-card ${categoryClass} p-3`;
                areaCard.innerHTML = `
                    <h4 class="font-medium text-base">${result.name}</h4>
                    <div class="grid grid-cols-2 gap-2 mt-2 text-sm">
                        <div>
                            <div class="text-gray-300">Area:</div>
                            <div class="font-medium">${Math.round(result.area).toLocaleString()} sq ft</div>
                        </div>
                        <div>
                            <div class="text-gray-300">Runoff Coefficient:</div>
                            <div class="font-medium">${result.coefficient}%</div>
                        </div>
                        <div>
                            <div class="text-gray-300">Annual Collection:</div>
                            <div class="font-medium">${Math.round(result.gallons).toLocaleString()} gallons</div>
                        </div>
                        <div>
                            <div class="text-gray-300">Monthly Average:</div>
                            <div class="font-medium">${Math.round(result.monthlyAvg).toLocaleString()} gallons</div>
                        </div>
                    </div>
                `;
                individualAreaList.appendChild(areaCard);
            });
            
            // Generate table rows
            const tableBody = document.getElementById('results-table-body');
            tableBody.innerHTML = '';
            
            months.forEach((month, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">${month}</td>
                    <td class="px-6 py-4 text-right whitespace-nowrap">${monthlyRainfall[index].toFixed(2)}</td>
                    <td class="px-6 py-4 text-right whitespace-nowrap">${Math.round(monthlyCollection[index]).toLocaleString()}</td>
                `;
                tableBody.appendChild(row);
            });
            
            // Create or update chart
            createOrUpdateChart(months, monthlyRainfall, monthlyCollection);
        }

        function createOrUpdateChart(labels, rainfallData, collectionData) {
            const chartCanvas = document.getElementById('rainfall-chart');
            
            // If chart already exists, destroy it before creating a new one
            if (rainfallChart) {
                rainfallChart.destroy();
            }
            
            // Create new chart
            rainfallChart = new Chart(chartCanvas, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Rainfall (inches)',
                            data: rainfallData,
                            backgroundColor: 'rgba(54, 162, 235, 0.5)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Water Collected (gallons)',
                            data: collectionData,
                            backgroundColor: 'rgba(236, 30, 125, 0.5)',
                            borderColor: 'rgba(236, 30, 125, 1)',
                            borderWidth: 1,
                            type: 'line',
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#ffffff'
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: '#ffffff'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Rainfall (inches)',
                                color: '#ffffff'
                            },
                            ticks: {
                                color: '#ffffff'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Water Collected (gallons)',
                                color: '#ffffff'
                            },
                            ticks: {
                                color: '#ffffff'
                            },
                            grid: {
                                drawOnChartArea: false,
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    }
                }
            });
        }

        // Initialize the map when the page loads
        window.addEventListener('load', function() {
            if (typeof google !== 'undefined' && google.maps) {
                // Check if Places library is loaded
                if (typeof google.maps.places === 'undefined') {
                    // Load Places library if needed
                    const script = document.createElement('script');
                    script.src = `https://maps.googleapis.com/maps/api/js?key=AIzaSyAuFONHLyXGalqEH9VL3oFl8MpHgF7sa5k&libraries=places,drawing,geometry&callback=initMap`;
                    script.async = true;
                    script.defer = true;
                    document.head.appendChild(script);
                } else {
                    initMap();
                }
            } else {
                console.error('Google Maps API not loaded properly');
            }
        });
    </script>
</body>
</html>
